<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatBot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
    <canvas id="particleCanvas"></canvas>
    
    {% if user %}
        <!-- Welcome Overlay -->
        <div class="welcome-overlay" id="welcomeOverlay">
            <div class="welcome-center">
                <h1>Research Analyst Bot</h1>
                <p>By Researchers, For Researchers</p>
            </div>
        </div>
        
        <div class="container">
            <div class="layout">
                <!-- Sidebar -->
                <div id="sidebar" class="sidebar hidden">
                    <div class="sidebar-header">
                        <h2>History</h2>
                        <button onclick="toggleSidebar()">✖</button>
                    </div>
                    <div class="history-list" id="historyList"></div>
                </div>

                <!-- Main Content -->
                <div class="main">
                    <div class="header">
                        <button class="menu-btn" onclick="toggleSidebar()">☰</button>
                        <div class="welcome-text">
                            <h1>Research Analyst Bot</h1>
                            <p>By Researchers, For Researchers</p>
                        </div>
                        <button class="logout-btn"><a href="/logout" id="logout-link">Logout</a></button>
                    </div>

                    <!-- Chat messages area -->
                    <div class="chat-window" id="chat-window"></div>

                    <!-- Input area -->
                    <div class="chatbox">
                        <input
                            type="text"
                            id="userInput"
                            placeholder="Send a message..."
                            onkeypress="handleKeyPress(event)"
                        />
                        <button class="send-btn" onclick="sendMessage()">⏎</button>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Research-themed animated background -->
        <div class="research-bg" id="researchBG">
            {% for i in range(40) %}
                <div class="research-particle" style="
                    left: {{ (i * 2.3) % 100 }}vw;
                    top: {{ (i * 4.7) % 100 }}vh;
                    animation-delay: {{ (i * 0.5) % 5 }}s;
                    animation-duration: {{ 7 + (i % 5) }}s;
                "></div>
            {% endfor %}
        </div>

        <div class="auth-wrapper" style="background: transparent; border: none;">
            <div class="welcome-text">
                <h1>Research Analyst Bot</h1>
                <p style="text-align: center; padding-bottom: 5px;">By Researchers, For Researchers</p>
            </div>
            <p style="font-style: italic; font-weight: bold; color: aqua;">You are not logged in.</p>
            <div class="auth-buttons">
                <button onclick="toggleForms('login')">Login</button>
                <button onclick="toggleForms('register')">Register</button>
            </div>
        </div>        
            
        <!-- Login dialog box-->
        <div id="loginDialog" class="auth-dialog" style="display:none;">
            <form method="POST" action="/login">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="username">Username:</label>
                <input type="text" name="username" placeholder="Username" required><br>
                <label for="password">Password:</label>
                <input type="password" name="password" placeholder="Password" required><br>
                <button type="submit">Login</button>
            </form>
            <p>Don't have an account? <a href="#" onclick="toggleForms('register')">Register here</a></p>
        </div>

        <!-- Registration Dialog Box -->
        <div id="registerDialog" class="auth-dialog" style="display:none;">
            <form method="POST" action="/register">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="username">Username:</label>
                <input type="text" name="username" placeholder="New Username" required><br>
                <label for="password">Password:</label>
                <input type="password" name="password" placeholder="New Password" required><br>
                <button type="submit">Register</button>
            </form>
            <p>Already have an account? <a href="#" onclick="toggleForms('login')">Login here</a></p>
        </div>
    {% endif %}
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Hide the welcome overlay after 2 seconds
        window.onload = function() {
            setTimeout(function() {
                const welcomeOverlay = document.getElementById("welcomeOverlay");
                if (welcomeOverlay) {
                    welcomeOverlay.style.display = "none";
                }
            }, 2000);
            
            // Only send "Greetings" if the chat is empty and user is logged in
            setTimeout(() => {
                {% if user %}
                    const chatBox = document.getElementById("chat-window");
                    if (chatBox && chatBox.children.length === 0) {
                        document.getElementById("userInput").value = "Greetings";
                        sendMessage();
                    }
                {% endif %}
            }, 3500);
        };
        
        function toggleForms(formType) {
            const login = document.getElementById('loginDialog');
            const register = document.getElementById('registerDialog');
            const wrapper = document.querySelector('.auth-wrapper');
    
            if (formType === 'login') {
                login.style.display = 'block';
                register.style.display = 'none';
            } else {
                login.style.display = 'none';
                register.style.display = 'block';
            }
    
            // Hide the welcome text and login/register buttons
            if (wrapper) wrapper.style.display = 'none';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>            
    <script>
        const canvas = document.getElementById("particleCanvas");
        if (canvas) {
            const ctx = canvas.getContext("2d");
          
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          
            let particles = [];
            const numParticles = 100;
          
            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5,
                    radius: Math.random() * 1.2 + 0.3
                });
            }
          
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            
                for (let p of particles) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = "#0ff"; // glowing blue
                    ctx.shadowColor = "#0ff";
                    ctx.shadowBlur = 10;
                    ctx.fill();
            
                    p.x += p.vx;
                    p.y += p.vy;
            
                    // bounce off edges
                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                }
            
                requestAnimationFrame(draw);
            }
          
            draw();
          
            window.addEventListener("resize", () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
    </script>                          
</body>
</html>